<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DÃ¼nya HaritasÄ± Quiz Oyunu</title>
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for geographic visualization --><script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Robinson Projeksiyonu iÃ§in D3-Geo-Projection Eklendi --><script src="https://unpkg.com/d3-geo-projection@4"></script>
    <!-- TopoJSON library for map data processing --><script src="https://unpkg.com/topojson@3"></script>

    <!-- Firebase SDKs --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Auth ve Firestore kÃ¼tÃ¼phaneleri dÄ±ÅŸarÄ±dan eriÅŸilemezse, anonim giriÅŸ iÃ§in gerekli olanÄ± tutalÄ±m:
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore kullanÄ±lmadÄ±ÄŸÄ± iÃ§in gereksiz importlar temizlendi.
        // EÄŸer ileride skoru kaydetmek isterseniz getFirestore, doc, setDoc vb. ekleyebilirsiniz.

        // ğŸš¨ Ã–NEMLÄ°: Kendi Firebase YapÄ±landÄ±rmanÄ±zÄ± Buraya Girin ğŸš¨
        // Bu kod, Canvas ortamÄ± dÄ±ÅŸÄ±ndaki yerlerde (GitHub Pages gibi) Ã§alÄ±ÅŸmak Ã¼zere gÃ¼ncellenmiÅŸtir.
        // Kendi Firebase konsolunuzdan aldÄ±ÄŸÄ±nÄ±z bilgileri buraya yapÄ±ÅŸtÄ±rÄ±n.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE", // <-- BURAYA API KEY'Ä°NÄ°ZÄ° YAZIN
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", // <-- BURAYA PROJE ID'NÄ°ZÄ° YAZIN
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID" // <-- BURAYA UYGULAMA ID'NÄ°ZÄ° YAZIN
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // const db = getFirestore(app); // Firestore artÄ±k kullanÄ±lmÄ±yor
        const auth = getAuth(app);
        
        // Global eriÅŸim iÃ§in gerekli olanlarÄ± window'a ata
        window.firebase = {
            auth,
            signInAnonymously, 
            onAuthStateChanged,
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
        }
        #map-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            aspect-ratio: 2.1 / 1; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15); 
        }
        .country {
            fill: #d1d5db;
            stroke: #ffffff;
            stroke-width: 0.5px;
            transition: fill 0.4s ease, stroke-width 0.2s ease;
            cursor: pointer;
        }
        .ocean {
            fill: #60a5fa;
        }
        .country-guessed {
            fill: #10b981 !important;
            stroke: #059669;
        }
        .country:not(.country-guessed):hover {
            fill: #99a7fd;
            stroke-width: 1.5px;
        }
        .game-title {
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
            background: linear-gradient(90deg, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .ui-card {
            border-radius: 1.5rem;
            background: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        .ui-card:hover {
             transform: translateY(-2px);
        }
        .loader-ring {
            border: 4px solid #e0e7ff;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen flex flex-col items-center">

    <div class="max-w-5xl w-full">
        <!-- Header --><header class="text-center mb-10">
            <h1 class="game-title text-5xl font-extrabold mb-3">
                ğŸŒ DÃ¼nya HaritasÄ± Quiz Oyunu
            </h1>
            <p class="text-gray-600 font-medium">15 dakika iÃ§inde haritadaki tÃ¼m Ã¼lkeleri TÃ¼rkÃ§e adlarÄ±yla tahmin et!</p>
            <p id="user-id-display" class="text-xs mt-2 text-gray-400">KullanÄ±cÄ± KimliÄŸi: YÃ¼kleniyor...</p>
        </header>

        <!-- Game Dashboard and Map --><main class="grid grid-cols-1 lg:col-cols-3 gap-8">

            <!-- Left Column: Controls and Timer --><div class="lg:col-span-1 space-y-6">
                
                <!-- Score Card --><div class="ui-card flex justify-around space-x-4 p-4">
                    <!-- Score Counter --><div class="text-center flex-1 p-3 rounded-xl bg-green-50/70 border border-green-200 shadow-inner">
                        <p class="text-sm font-semibold text-gray-500 flex items-center justify-center mb-1">
                            <span class="mr-1 text-xl">âœ…</span> DoÄŸru
                        </p>
                        <span id="score" class="text-3xl font-extrabold text-green-600 transition duration-500">0 / 0</span>
                    </div>

                    <!-- Timer --><div class="text-center flex-1 p-3 rounded-xl bg-red-50/70 border border-red-200 shadow-inner">
                        <p class="text-sm font-semibold text-gray-500 flex items-center justify-center mb-1">
                             <span class="mr-1 text-xl">â±ï¸</span> Kalan SÃ¼re
                        </p>
                        <span id="timer" class="text-3xl font-extrabold text-red-500 transition duration-500">15:00</span>
                    </div>
                </div>

                <!-- Input/Start Section --><div class="ui-card">
                    <button id="startButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-xl hover:shadow-2xl transition duration-300 disabled:opacity-50 disabled:bg-gray-400">
                        Oyunu BaÅŸlat
                    </button>

                    <div id="input-area" class="mt-4 hidden">
                        <label for="countryInput" class="block text-sm font-semibold text-gray-700 mb-2">Ãœlke AdÄ± Girin (TÃ¼rkÃ§e veya Ä°ngilizce):</label>
                        <input type="text" id="countryInput" placeholder="Ãœlke adÄ± girin..." class="w-full p-4 border-2 border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 text-lg" disabled autocomplete="off">
                        <div id="feedbackMessage" class="mt-3 text-center font-bold h-6 text-sm"></div>
                    </div>
                    <button id="finishButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl shadow-lg transition duration-300 mt-4 hidden">
                        Oyunu Bitir ve Sonucu GÃ¶r
                    </button>
                </div>

                <!-- Share Section --><div class="ui-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b-2 border-gray-100 pb-2">ğŸ“¢ BaÅŸarÄ±nÄ± PaylaÅŸ</h2>
                    <div id="share-buttons" class="flex flex-col space-y-3 mt-4">
                        <p id="share-message" class="text-center text-gray-600 font-medium">Oyun bittiÄŸinde skorunu burada paylaÅŸabilirsin.</p>
                        
                        <button id="shareTwitterButton" class="flex items-center justify-center bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition duration-200 disabled:opacity-50 shadow-md hidden" disabled>
                            <svg class="w-5 h-5 mr-2 fill-current" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.14l-6.286-8.114L5.356 22.75H1.054l8.23-10.14-8.23-11.41h3.766l5.247 7.633L18.244 2.25zM17.206 19.444h2.413L8.09 4.26H5.327l11.879 15.184z"/></svg>
                            X'te PaylaÅŸ
                        </button>
                        
                        <button id="shareWhatsappButton" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition duration-200 disabled:opacity-50 shadow-md hidden" disabled>
                            <svg class="w-5 h-5 mr-2 fill-current" viewBox="0 0 24 24"><path d="M12.001 2c-5.522 0-10 4.478-10 10s4.478 10 10 10c1.472 0 2.868-.32 4.123-.923L22 22l-.723-5.323c.603-1.255.923-2.651.923-4.123 0-5.522-4.478-10-10-10zm-3.001 14.5c-.32 0-.64-.096-.923-.289-.289-.193-.53-.473-.663-.788l-.066-.153c-.352-.82-.705-1.64-1.057-2.46-.193-.442-.096-.923.193-1.206l.53-.53c.289-.289.769-.289 1.057 0l1.345 1.345c.289.289.289.769 0 1.057l-.53.53c-.193.193-.193.473 0 .663l.352.352c.289.289.769.289 1.057 0l1.345-1.345c.289-.289.769-.289 1.057 0l1.345 1.345c.289.289.769.289 1.057 0l1.345-1.345c.289-.289.769-.289 1.057 0l.53.53c.289.289.385.769.096 1.206l-1.057 2.46c-.193.442-.64.731-1.057.731l-5.323.096z"/></svg>
                            WhatsApp'ta PaylaÅŸ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Map Container --><div class="lg:col-span-2 ui-card flex items-center justify-center p-0">
                <div id="map-container" class="relative w-full h-full rounded-2xl overflow-hidden">
                    <svg id="world-map"></svg>
                    <!-- Loading indicator for map/data --><div id="map-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90">
                        <div class="loader-ring mb-3"></div>
                        <p class="ml-3 text-lg font-bold text-indigo-600">Harita Verileri YÃ¼kleniyor...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals --><!-- Game End Modal --><div id="gameEndModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center transform scale-100 transition-all duration-300">
            <h3 class="text-3xl font-extrabold text-indigo-600 mb-4">Oyun Bitti!</h3>
            <p class="text-xl text-gray-700 mb-6 font-semibold">BaÅŸarÄ± YÃ¼zdesi:</p>
            <p id="finalScore" class="font-extrabold text-5xl text-green-600 mb-6">0%</p>
            
            <button id="closeModalButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition duration-200 shadow-md">
                Kapat
            </button>
        </div>
    </div>
    
    <script type="module">
        let auth; // Firebase Auth objesi
        let userId = 'default-user'; // KullanÄ±cÄ± kimliÄŸi
        
        let mapData = null; 
        let countryNamesMap = {}; 
        let totalCountries = 0; 
        let guessedCountries = new Set();
        let scoreCount = 0;
        let timerInterval = null;
        let timeLeft = 15 * 60; 
        let gameActive = false;
        let finalPercentage = 0; 
        
        let debounceTimeout = null;
        const DEBOUNCE_DELAY = 500; 

        const startButton = document.getElementById('startButton');
        const finishButton = document.getElementById('finishButton');
        const countryInput = document.getElementById('countryInput');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const inputArea = document.getElementById('input-area');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const mapLoader = document.getElementById('map-loader');
        const mapSVG = d3.select("#world-map");
        const gameEndModal = document.getElementById('gameEndModal');
        const finalScoreDisplay = document.getElementById('finalScore');
        const closeModalButton = document.getElementById('closeModalButton');
        const userIdDisplay = document.getElementById('user-id-display');
        
        const shareMessage = document.getElementById('share-message');
        const shareTwitterButton = document.getElementById('shareTwitterButton');
        const shareWhatsappButton = document.getElementById('shareWhatsappButton');

        window.addEventListener('load', async () => {
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase services failed to load. Check your API configuration.");
                mapLoader.innerHTML = "<p class='ml-3 text-lg font-semibold text-red-500'>Hata: Firebase yÃ¼klenemedi. LÃ¼tfen yapÄ±landÄ±rmayÄ± kontrol edin.</p>";
                startButton.disabled = true;
                return;
            }
            
            auth = window.firebase.auth;
            
            // 1. Anonim GiriÅŸ Yap
            try {
                // Anonim olarak oturum aÃ§ (GitHub'da Ã§alÄ±ÅŸÄ±rken bu en kolay yÃ¶ntemdir)
                await window.firebase.signInAnonymously(auth);
                console.log("Firebase: Anonim olarak oturum aÃ§Ä±ldÄ±.");
            } catch (error) {
                console.error("Firebase GiriÅŸ HatasÄ±:", error);
                // GiriÅŸ baÅŸarÄ±sÄ±z olsa bile harita yÃ¼klensin (oyun Firestore kullanmadÄ±ÄŸÄ± iÃ§in sorun olmaz)
            }
            
            // 2. Auth Durumu DeÄŸiÅŸtiÄŸinde KullanÄ±cÄ± Bilgisini Al ve HaritayÄ± YÃ¼kle
            window.firebase.onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `KullanÄ±cÄ± KimliÄŸi: ${userId.substring(0, 8)}...`;
                    loadMapData();
                } else {
                    console.error("Authentication failed. Defaulting to unique ID.");
                    userId = 'anon-user-' + crypto.randomUUID();
                    loadMapData(); 
                }
            });
        });

        async function loadMapData() {
            const topoJsonUrl = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json"; 
            const maxRetries = 3;
            let data = null;
            let error = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(topoJsonUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP Hata: ${response.status}`);
                    }
                    data = await response.json();
                    error = null;
                    break; 
                } catch (e) {
                    error = e;
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Harita yÃ¼klenemedi. Deneme ${i + 1} baÅŸarÄ±sÄ±z. ${delay / 1000} saniye bekleniyor...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (error || !data) {
                console.error("Harita verisi yÃ¼klenirken hata oluÅŸtu:", error);
                mapLoader.innerHTML = "<p class='ml-3 text-lg font-semibold text-red-500'>Hata: Harita yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</p>";
                startButton.disabled = true;
                return; 
            }

            try {
                mapData = topojson.feature(data, data.objects.countries);
                
                let initialCountryCount = 0; 
                countryNamesMap = {}; 

                countryNamesMap = mapData.features.reduce((acc, d) => {
                    if (d.id == null || d.properties == null || d.properties.name == null) {
                         console.warn("Ãœlke verisi eksik ID veya isim nedeniyle atlandÄ±:", d);
                         return acc;
                    }

                    d.id = d.id.toString(); 
                    
                    const name = d.properties.name.toLowerCase();
                    const idString = d.id;
                    let turkishName = name; 
                    
                    // --- GeniÅŸletilmiÅŸ ve GÃ¼ncellenmiÅŸ TÃ¼rkÃ§e Ä°sim EÅŸleÅŸtirmesi ---
                    if (name === 'turkey') turkishName = 'tÃ¼rkiye';
                    else if (name === 'united states') turkishName = 'birleÅŸik devletler';
                    else if (name === 'russia') turkishName = 'rusya';
                    else if (name === 'germany') turkishName = 'almanya';
                    else if (name === 'france') turkishName = 'fransa';
                    else if (name === 'united kingdom') turkishName = 'birleÅŸik krallÄ±k';
                    else if (name === 'spain') turkishName = 'ispanya';
                    else if (name === 'italy') turkishName = 'italya';
                    else if (name === 'japan') turkishName = 'japonya';
                    else if (name === 'china') turkishName = 'Ã§in';
                    else if (name === 'brazil') turkishName = 'brezilya';
                    else if (name === 'canada') turkishName = 'kanada';
                    else if (name === 'india') turkishName = 'hindistan';
                    else if (name === 'australia') turkishName = 'avustralya';
                    else if (name === 'mexico') turkishName = 'meksika';
                    else if (name === 'argentina') turkishName = 'arjantin';
                    else if (name === 'south africa') turkishName = 'gÃ¼ney afrika';
                    else if (name === 'egypt') turkishName = 'mÄ±sÄ±r';
                    else if (name === 'iran') turkishName = 'iran';
                    else if (name === 'iraq') turkishName = 'Ä±rak';
                    else if (name === 'saudi arabia') turkishName = 'suudi arabistan';
                    else if (name === 'kazakhstan') turkishName = 'kazakistan';
                    else if (name === 'greece') turkishName = 'yunanistan';
                    else if (name === 'netherlands') turkishName = 'hollanda';
                    else if (name === 'belgium') turkishName = 'belÃ§ika';
                    else if (name === 'sweden') turkishName = 'isveÃ§';
                    else if (name === 'norway') turkishName = 'norveÃ§';
                    else if (name === 'finland') turkishName = 'finlandiya';
                    else if (name === 'portugal') turkishName = 'portekiz';
                    else if (name === 'poland') turkishName = 'polonya';
                    else if (name === 'ukraine') turkishName = 'ukrayna';
                    else if (name === 'afghanistan') turkishName = 'afganistan';
                    else if (name === 'syria') turkishName = 'suriye';
                    else if (name === 'denmark') turkishName = 'danimarka';
                    else if (name === 'switzerland') turkishName = 'isviÃ§re';
                    else if (name === 'austria') turkishName = 'avusturya';
                    else if (name === 'peru') turkishName = 'peru';
                    else if (name === 'colombia') turkishName = 'kolombiya';
                    else if (name === 'chile') turkishName = 'ÅŸili';
                    else if (name === 'indonesia') turkishName = 'endonezya';
                    else if (name === 'philippines') turkishName = 'filipinler';
                    else if (name === 'vietnam') turkishName = 'vietnam';
                    else if (name === 'thailand') turkishName = 'tayland';
                    else if (name === 'pakistan') turkishName = 'pakistan';
                    else if (name === 'nigeria') turkishName = 'nijerya';
                    else if (name === 'kenya') turkishName = 'kenya';
                    else if (name === 'morocco') turkishName = 'fas';
                    else if (name === 'algeria') turkishName = 'cezayir';
                    else if (name === 'libya') turkishName = 'libya';
                    else if (name === 'iceland') turkishName = 'izlanda';
                    else if (name === 'ireland') turkishName = 'irlanda';
                    else if (name === 'israel') turkishName = 'israil';
                    else if (name === 'cuba') turkishName = 'kÃ¼ba';
                    else if (name === 'new zealand') turkishName = 'yeni zelanda';
                    else if (name === 'south korea') turkishName = 'gÃ¼ney kore';
                    else if (name === 'north korea') turkishName = 'kuzey kore';
                    else if (name === 'venezuela') turkishName = 'venezuela';
                    else if (name === 'turkmenistan') turkishName = 'tÃ¼rkmenistan';
                    else if (name === 'uzbekistan') turkishName = 'Ã¶zbekistan';
                    else if (name === 'azerbaijan') turkishName = 'azerbaycan';
                    else if (name === 'georgia') turkishName = 'gÃ¼rcistan';
                    else if (name === 'armenia') turkishName = 'ermenistan';
                    else if (name === 'bulgaria') turkishName = 'bulgaristan';
                    else if (name === 'romania') turkishName = 'romanya';
                    else if (name === 'hungary') turkishName = 'macaristan';
                    else if (name === 'czechia') turkishName = 'Ã§ekya';
                    else if (name === 'slovakia') turkishName = 'slovakya';
                    else if (name === 'slovenia') turkishName = 'slovenya';
                    else if (name === 'croatia') turkishName = 'hÄ±rvatistan';
                    else if (name === 'serbia') turkishName = 'sÄ±rbistan';
                    else if (name === 'bosnia and herz.') turkishName = 'bosna hersek';
                    else if (name === 'albania') turkishName = 'arnavutluk';
                    else if (name === 'macedonia') turkishName = 'makedonya';
                    else if (name === 'kosovo') turkishName = 'kosova';
                    else if (name === 'cyprus') turkishName = 'kÄ±brÄ±s';
                    else if (name === 'mongolia') turkishName = 'moÄŸolistan';
                    else if (name === 'kyrgyzstan') turkishName = 'kÄ±rgÄ±zistan';
                    else if (name === 'madagascar') turkishName = 'madagaskar';
                    else if (name === 'greenland') turkishName = 'grÃ¶nland';

                    acc[name] = { id: idString, turkish: turkishName, isMapCountry: true };
                    
                    if (turkishName !== name) {
                       acc[turkishName] = { id: idString, turkish: turkishName, isMapCountry: true };
                    }
                    
                    if (name === 'united states') {
                        acc['abd'] = { id: idString, turkish: turkishName, isMapCountry: true };
                        acc['amerika'] = { id: idString, turkish: turkishName, isMapCountry: true };
                    }
                    if (name === 'united kingdom') {
                        acc['uk'] = { id: idString, turkish: turkishName, isMapCountry: true };
                        acc['bÃ¼yÃ¼k britanya'] = { id: idString, turkish: turkishName, isMapCountry: true };
                    }
                    if (name === 'netherlands') {
                        acc['flemenk'] = { id: idString, turkish: turkishName, isMapCountry: true };
                    }
                    if (name === 'czechia') {
                        acc['Ã§ek cumhuriyeti'] = { id: idString, turkish: turkishName, isMapCountry: true };
                    }
                    if (name === 'greenland') {
                        acc['greenland'] = { id: idString, turkish: 'grÃ¶nland', isMapCountry: true }; 
                    }
                    
                    initialCountryCount++;
                    return acc;
                }, {});

                // --- MANUEL OLARAK EKLENEN ÃœLKELER (Haritada gÃ¶rÃ¼nmeyen kÃ¼Ã§Ã¼k devletler) ---
                const manualCountries = [
                    { name: 'vatican', turkish: 'vatikan' },
                    { name: 'san marino', turkish: 'san marino' },
                    { name: 'palestine', turkish: 'filistin' },
                    { name: 'taiwan', turkish: 'tayvan' },
                    { name: 'kosovo', turkish: 'kosova' }, 
                    { name: 'liechtenstein', turkish: 'lihtenÅŸtayn' },
                    { name: 'andorra', turkish: 'andorra' },
                    { name: 'malta', turkish: 'malta' },
                    { name: 'luxembourg', turkish: 'lÃ¼ksemburg' },
                    { name: 'singapore', turkish: 'singapur' },
                    { name: 'bahrain', turkish: 'bahreyn' },
                    { name: 'qatar', turkish: 'katar' },
                    { name: 'kuwait', turkish: 'kuveyt' },
                    { name: 'brunei', turkish: 'brunei' },
                    { name: 'seychelles', turkish: 'seyÅŸeller' },
                    { name: 'maldives', turkish: 'maldivler' },
                    { name: 'monaco', turkish: 'monako' },
                ];

                manualCountries.forEach(country => {
                    const uniqueId = `manual-${country.name}`; 
                    const nameLower = country.name.toLowerCase();
                    const turkishLower = country.turkish.toLowerCase();

                    if (!countryNamesMap[nameLower] && !countryNamesMap[turkishLower]) {
                        countryNamesMap[nameLower] = { id: uniqueId, turkish: country.turkish, isMapCountry: false };
                        if (turkishLower !== nameLower) {
                            countryNamesMap[turkishLower] = { id: uniqueId, turkish: country.turkish, isMapCountry: false };
                        }
                        initialCountryCount++; 
                    }
                });

                totalCountries = initialCountryCount;
                scoreDisplay.textContent = `${scoreCount} / ${totalCountries}`;

                drawMap();
                mapLoader.classList.add('hidden');
                startButton.disabled = false;
                
            } catch (e) {
                console.error("Harita iÅŸlenirken hata oluÅŸtu:", e);
                mapLoader.innerHTML = "<p class='ml-3 text-lg font-semibold text-red-500'>Hata: Harita yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</p>";
                startButton.disabled = true;
            }
        }
        
        function drawMap() {
            const container = document.getElementById('map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            mapSVG.attr("width", width).attr("height", height);

            const projection = d3.geoRobinson();

            if (mapData && mapData.features.length > 0) {
                 projection.fitSize([width, height], mapData);
            } else {
                 projection.scale(width / 5.5).translate([width / 2, height / 1.9]);
            }
           
            const path = d3.geoPath().projection(projection);

            mapSVG.selectAll("*").remove(); 

            mapSVG.append("path")
                .datum({type: "Sphere"})
                .attr("class", "ocean")
                .attr("d", path);

            mapSVG.selectAll(".country")
                .data(mapData.features)
                .enter().append("path")
                .attr("class", "country")
                .attr("data-id", d => d.id != null ? d.id.toString() : 'no-id') 
                .attr("d", path)
                .classed("country-guessed", d => d.id != null ? guessedCountries.has(d.id.toString()) : false); 
        }

        // --- Oyun Kontrolleri ---

        function startGame() {
            gameActive = true;
            scoreCount = 0;
            guessedCountries.clear();
            timeLeft = 15 * 60;
            
            scoreDisplay.textContent = `${scoreCount} / ${totalCountries}`;
            updateTimerDisplay();
            
            mapSVG.selectAll(".country").classed("country-guessed", false);

            startButton.classList.add('hidden');
            finishButton.classList.remove('hidden');
            inputArea.classList.remove('hidden');
            countryInput.disabled = false;
            countryInput.focus();
            
            shareTwitterButton.classList.add('hidden');
            shareWhatsappButton.classList.add('hidden');
            shareMessage.textContent = 'Oyun bittiÄŸinde skorunu burada paylaÅŸabilirsin.';

            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                endGame();
            } else {
                timeLeft--;
                updateTimerDisplay();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft < 60) {
                timerDisplay.classList.add('text-yellow-600'); 
            } else {
                 timerDisplay.classList.remove('text-yellow-600');
            }
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            countryInput.disabled = true;
            
            finalPercentage = Math.round((scoreCount / totalCountries) * 100);
            finalScoreDisplay.textContent = `${finalPercentage}% (${scoreCount} / ${totalCountries})`;

            gameEndModal.classList.remove('hidden');
            gameEndModal.classList.add('flex');

            prepareShareButtons();

            startButton.classList.remove('hidden');
            finishButton.classList.add('hidden');
            inputArea.classList.add('hidden');
        }
        
        function prepareShareButtons() {
            const finalScoreText = `${scoreCount} / ${totalCountries} Ã¼lkeyi bilerek DÃ¼nya HaritasÄ± Quiz'ini ${finalPercentage}% baÅŸarÄ±yla tamamladÄ±m! Harita coÄŸrafyasÄ± bilgimi test et!`;
            const encodedText = encodeURIComponent(finalScoreText + " #DÃ¼nyaQuiz #CoÄŸrafyaOyunu");
            const url = encodeURIComponent(window.location.href);

            shareMessage.textContent = finalScoreText;
            
            shareTwitterButton.href = `https://twitter.com/intent/tweet?text=${encodedText}&url=${url}`;
            shareTwitterButton.onclick = () => window.open(shareTwitterButton.href, '_blank');
            shareTwitterButton.classList.remove('hidden');
            
            shareWhatsappButton.href = `whatsapp://send?text=${encodedText} ${url}`;
            shareWhatsappButton.onclick = () => window.open(shareWhatsappButton.href, '_blank');
            shareWhatsappButton.classList.remove('hidden');
            
            shareTwitterButton.disabled = false;
            shareWhatsappButton.disabled = false;
        }

        function checkGuess() {
            if (!gameActive) return;

            let guess = countryInput.value.trim().toLowerCase();
            
            if (!guess) {
                 feedbackMessage.textContent = ''; 
                 return;
            }

            const countryInfo = countryNamesMap[guess];
            
            if (countryInfo) {
                const countryId = countryInfo.id;
                
                if (!guessedCountries.has(countryId)) {
                    guessedCountries.add(countryId);
                    scoreCount++;
                    scoreDisplay.textContent = `${scoreCount} / ${totalCountries}`;
                    
                    countryInput.value = ''; 
                    clearTimeout(debounceTimeout); 
                    
                    const countryNameDisplay = countryInfo.turkish.charAt(0).toUpperCase() + countryInfo.turkish.slice(1);
                    showFeedback(`DoÄŸru! (${countryNameDisplay}) ğŸ‰`, 'text-green-600');

                    if (countryInfo.isMapCountry) {
                        d3.select(`.country[data-id='${countryId}']`).classed("country-guessed", true);
                    }
                    
                    if (scoreCount === totalCountries) {
                        endGame();
                    }

                } else {
                    showFeedback('Bu Ã¼lkeyi zaten bildin. ğŸ¤”', 'text-yellow-600');
                    countryInput.value = ''; 
                    clearTimeout(debounceTimeout);
                }
            } else {
                showFeedback('YanlÄ±ÅŸ veya bilinmeyen Ã¼lke. Tekrar dene. âŒ', 'text-red-600');
            }
        }
        
        function handleInput() {
            clearTimeout(debounceTimeout);
            
            debounceTimeout = setTimeout(() => {
                checkGuess();
            }, DEBOUNCE_DELAY);
        }
        
        function showFeedback(message, colorClass) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `mt-3 text-center font-bold h-6 text-sm ${colorClass}`;
            setTimeout(() => {
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'mt-3 text-center font-bold h-6 text-sm';
            }, 1500); 
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);
        finishButton.addEventListener('click', endGame);
        
        countryInput.addEventListener('input', handleInput); 
        
        countryInput.addEventListener('keypress', (event) => {
            if (!gameActive) return;
            
            if (event.key === 'Enter') {
                clearTimeout(debounceTimeout);
                checkGuess();
                event.preventDefault(); 
            } 
        });

        countryInput.addEventListener('keyup', (event) => {
             if (!gameActive) return;
             
             if (event.key === ' ' && countryInput.value.trim().length > 0) {
                 clearTimeout(debounceTimeout);
                 checkGuess();
             }
        });


        closeModalButton.addEventListener('click', () => {
            gameEndModal.classList.add('hidden');
            gameEndModal.classList.remove('flex');
        });

        window.addEventListener('resize', () => {
             if (mapData) {
                drawMap();
            }
        });
        
    </script>
</body>
</html>